name: Deploy to Server

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: 109.172.46.96
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /var/www || mkdir -p /var/www
            cd /var/www
            if [ -d "pochtahub" ]; then
              cd pochtahub
              git pull
            else
              git clone https://github.com/PerfZero/pochtahub.git
              cd pochtahub
            fi
            
            if [ ! -d "venv" ]; then
              python3 -m venv venv
            fi
            
            source venv/bin/activate
            cd backend
            pip install -r requirements.txt
            
            if [ ! -f ".env" ]; then
              cat > .env << EOF
            SECRET_KEY=django-insecure-change-me-in-production
            DEBUG=False
            ALLOWED_HOSTS=109.172.46.96,localhost,127.0.0.1
            
            DB_NAME=pochtahub
            DB_USER=postgres
            DB_PASSWORD=postgres
            DB_HOST=localhost
            DB_PORT=5432
            
            CORS_ALLOWED_ORIGINS=http://109.172.46.96,http://localhost:3000
            EOF
            fi
            
            python3 manage.py migrate
            python3 manage.py collectstatic --noinput
            
            if ! python3 manage.py shell -c "from apps.users.models import User; User.objects.filter(is_superuser=True).exists()" 2>/dev/null | grep -q True; then
              python3 manage.py shell -c "from apps.users.models import User; User.objects.create_superuser('admin', 'admin@example.com', 'admin123')" 2>/dev/null || echo "Суперпользователь уже существует"
            fi
            
            systemctl restart pochtahub || echo "Сервис не найден"
            
            echo "Развертывание завершено!"
